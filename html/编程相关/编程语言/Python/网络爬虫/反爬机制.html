<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="pandoc" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <title>D:\MyWiki/html/编程相关/编程语言/Python/网络爬虫/反爬机制.html</title>
  <style>
      code{white-space: pre-wrap;}
      span.smallcaps{font-variant: small-caps;}
      span.underline{text-decoration: underline;}
      div.column{display: inline-block; vertical-align: top; width: 50%;}
  </style>
  <style>
a.sourceLine { display: inline-block; line-height: 1.25; }
a.sourceLine { pointer-events: none; color: inherit; text-decoration: inherit; }
a.sourceLine:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; position: relative; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
code.sourceCode { white-space: pre-wrap; }
a.sourceLine { text-indent: -1em; padding-left: 1em; }
}
pre.numberSource a.sourceLine
  { position: relative; left: -4em; }
pre.numberSource a.sourceLine::before
  { content: attr(title);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; pointer-events: all; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {  }
@media screen {
a.sourceLine::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
  </style>
  <link rel="stylesheet" href="misty-light-windows.css" />
  <!--[if lt IE 9]>
    <script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.3/html5shiv-printshiv.min.js"></script>
  <![endif]-->
</head>
<body>
<h1 id="反爬机制">反爬机制</h1>
<h2 id="验证码识别">验证码识别</h2>
<ul>
<li>验证码分类
<ol type="1">
<li>图像类</li>
<li>滑动类</li>
<li>点击类</li>
<li>语言类</li>
</ol></li>
</ul>
<h3 id="灰度处理二值化降噪tesserocr-识别">灰度处理、二值化、降噪、tesserocr 识别</h3>
<ul>
<li><p>这类验证码大多是数字、字母的组合，国内也有使用汉字的。在这个基础上增加噪点、干扰线、变形、重叠、不同字体颜色等方法来增加识别难度。</p></li>
<li><p>一般步骤：</p>
<ol type="1">
<li>灰度处理</li>
<li>增加对比度<em>(可选)</em></li>
<li>二值化</li>
<li>降噪</li>
<li>倾斜校正分割字符</li>
<li>建立训练库</li>
<li>识别</li>
</ol></li>
<li><p>生成验证码</p>
<ul>
<li><p>使用<a href="https://github.com/lepture/captcha">Captcha</a></p></li>
<li><div class="sourceCode" id="cb1"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="cb1-1" title="1"><span class="im">from</span> claptcha <span class="im">import</span> Claptcha</a>
<a class="sourceLine" id="cb1-2" title="2"></a>
<a class="sourceLine" id="cb1-3" title="3">c <span class="op">=</span> Claptcha(<span class="st">&quot;8069&quot;</span>, <span class="st">&quot;/usr/share/fonts/truetype/freefont/FreeMono.ttf&quot;</span>)</a>
<a class="sourceLine" id="cb1-4" title="4">t,_ <span class="op">=</span> c.write(<span class="st">&#39;out.png&#39;</span>)</a></code></pre></div></li>
</ul></li>
<li><p>二维码识别</p>
<ul>
<li><div class="sourceCode" id="cb2"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="cb2-1" title="1">  <span class="im">from</span> PIL <span class="im">import</span> Image</a>
<a class="sourceLine" id="cb2-2" title="2">  <span class="im">import</span> tesserocr</a>
<a class="sourceLine" id="cb2-3" title="3"></a>
<a class="sourceLine" id="cb2-4" title="4">  p1 <span class="op">=</span> Image.<span class="bu">open</span>(<span class="st">&#39;1.png&#39;</span>)</a>
<a class="sourceLine" id="cb2-5" title="5">  tesserocr.image_to_text(p1)</a></code></pre></div></li>
</ul></li>
<li><p>灰度处理(二值化)</p>
<ul>
<li><div class="sourceCode" id="cb3"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="cb3-1" title="1">  <span class="kw">def</span> binarizing(img, threshold):  <span class="co"># 图片，阈值</span></a>
<a class="sourceLine" id="cb3-2" title="2">      <span class="co">&quot;&quot;&quot;传入image对象进行灰度、二值处理&quot;&quot;&quot;</span></a>
<a class="sourceLine" id="cb3-3" title="3">      img <span class="op">=</span> img.convert(<span class="st">&quot;L&quot;</span>) <span class="co"># 转灰度</span></a>
<a class="sourceLine" id="cb3-4" title="4">      pixdata <span class="op">=</span> img.load()</a>
<a class="sourceLine" id="cb3-5" title="5">      w, h <span class="op">=</span> img.size</a>
<a class="sourceLine" id="cb3-6" title="6">      <span class="co"># 遍历所有像素，大于阈值的为黑色</span></a>
<a class="sourceLine" id="cb3-7" title="7">      <span class="cf">for</span> y <span class="kw">in</span> <span class="bu">range</span>(h):</a>
<a class="sourceLine" id="cb3-8" title="8">          <span class="cf">for</span> x <span class="kw">in</span> <span class="bu">range</span>(w):</a>
<a class="sourceLine" id="cb3-9" title="9">              <span class="cf">if</span> pixdata[x, y] <span class="op">&lt;</span> threshold:</a>
<a class="sourceLine" id="cb3-10" title="10">                  pixdata[x, y] <span class="op">=</span> <span class="dv">0</span></a>
<a class="sourceLine" id="cb3-11" title="11">              <span class="cf">else</span>:</a>
<a class="sourceLine" id="cb3-12" title="12">                  pixdata[x, y] <span class="op">=</span> <span class="dv">255</span></a>
<a class="sourceLine" id="cb3-13" title="13">      <span class="cf">return</span> img</a></code></pre></div></li>
</ul></li>
<li><p>去除干扰线(降噪)</p>
<ul>
<li><div class="sourceCode" id="cb4"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="cb4-1" title="1">  <span class="kw">def</span> depoint(img):</a>
<a class="sourceLine" id="cb4-2" title="2">      <span class="co">&quot;&quot;&quot;传入二值化后的图片进行降噪&quot;&quot;&quot;</span></a>
<a class="sourceLine" id="cb4-3" title="3">      pixdata <span class="op">=</span> img.load()</a>
<a class="sourceLine" id="cb4-4" title="4">      w,h <span class="op">=</span> img.size</a>
<a class="sourceLine" id="cb4-5" title="5">      <span class="cf">for</span> y <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">1</span>,h<span class="dv">-1</span>):</a>
<a class="sourceLine" id="cb4-6" title="6">          <span class="cf">for</span> x <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">1</span>,w<span class="dv">-1</span>):</a>
<a class="sourceLine" id="cb4-7" title="7">              count <span class="op">=</span> <span class="dv">0</span></a>
<a class="sourceLine" id="cb4-8" title="8">              <span class="cf">if</span> pixdata[x,y<span class="dv">-1</span>] <span class="op">&gt;</span> <span class="dv">245</span>:<span class="co">#上</span></a>
<a class="sourceLine" id="cb4-9" title="9">                  count <span class="op">=</span> count <span class="op">+</span> <span class="dv">1</span></a>
<a class="sourceLine" id="cb4-10" title="10">              <span class="cf">if</span> pixdata[x,y<span class="op">+</span><span class="dv">1</span>] <span class="op">&gt;</span> <span class="dv">245</span>:<span class="co">#下</span></a>
<a class="sourceLine" id="cb4-11" title="11">                  count <span class="op">=</span> count <span class="op">+</span> <span class="dv">1</span></a>
<a class="sourceLine" id="cb4-12" title="12">              <span class="cf">if</span> pixdata[x<span class="dv">-1</span>,y] <span class="op">&gt;</span> <span class="dv">245</span>:<span class="co">#左</span></a>
<a class="sourceLine" id="cb4-13" title="13">                  count <span class="op">=</span> count <span class="op">+</span> <span class="dv">1</span></a>
<a class="sourceLine" id="cb4-14" title="14">              <span class="cf">if</span> pixdata[x<span class="op">+</span><span class="dv">1</span>,y] <span class="op">&gt;</span> <span class="dv">245</span>:<span class="co">#右</span></a>
<a class="sourceLine" id="cb4-15" title="15">                  count <span class="op">=</span> count <span class="op">+</span> <span class="dv">1</span></a>
<a class="sourceLine" id="cb4-16" title="16">              <span class="cf">if</span> pixdata[x<span class="dv">-1</span>,y<span class="dv">-1</span>] <span class="op">&gt;</span> <span class="dv">245</span>:<span class="co">#左上</span></a>
<a class="sourceLine" id="cb4-17" title="17">                  count <span class="op">=</span> count <span class="op">+</span> <span class="dv">1</span></a>
<a class="sourceLine" id="cb4-18" title="18">              <span class="cf">if</span> pixdata[x<span class="dv">-1</span>,y<span class="op">+</span><span class="dv">1</span>] <span class="op">&gt;</span> <span class="dv">245</span>:<span class="co">#左下</span></a>
<a class="sourceLine" id="cb4-19" title="19">                  count <span class="op">=</span> count <span class="op">+</span> <span class="dv">1</span></a>
<a class="sourceLine" id="cb4-20" title="20">              <span class="cf">if</span> pixdata[x<span class="op">+</span><span class="dv">1</span>,y<span class="dv">-1</span>] <span class="op">&gt;</span> <span class="dv">245</span>:<span class="co">#右上</span></a>
<a class="sourceLine" id="cb4-21" title="21">                  count <span class="op">=</span> count <span class="op">+</span> <span class="dv">1</span></a>
<a class="sourceLine" id="cb4-22" title="22">              <span class="cf">if</span> pixdata[x<span class="op">+</span><span class="dv">1</span>,y<span class="op">+</span><span class="dv">1</span>] <span class="op">&gt;</span> <span class="dv">245</span>:<span class="co">#右下</span></a>
<a class="sourceLine" id="cb4-23" title="23">                  count <span class="op">=</span> count <span class="op">+</span> <span class="dv">1</span></a>
<a class="sourceLine" id="cb4-24" title="24">              <span class="cf">if</span> count <span class="op">&gt;</span> <span class="dv">4</span>:</a>
<a class="sourceLine" id="cb4-25" title="25">                  pixdata[x,y] <span class="op">=</span> <span class="dv">255</span></a>
<a class="sourceLine" id="cb4-26" title="26">      <span class="cf">return</span> img</a></code></pre></div></li>
</ul></li>
</ul>
<h3 id="投影法连通域法分割图片">投影法、连通域法分割图片</h3>
<ul>
<li><p>切割法(位置固定)</p>
<ul>
<li><p>使用crop函数进行切割</p>
<ul>
<li><div class="sourceCode" id="cb5"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="cb5-1" title="1">  <span class="im">from</span> PIL <span class="im">import</span> Image</a>
<a class="sourceLine" id="cb5-2" title="2">  p <span class="op">=</span> Image.<span class="bu">open</span>(<span class="st">&quot;1.png&quot;</span>)</a>
<a class="sourceLine" id="cb5-3" title="3">  <span class="co"># 注意位置顺序为左、上、右、下</span></a>
<a class="sourceLine" id="cb5-4" title="4">  cuts <span class="op">=</span> [(<span class="dv">20</span>,<span class="dv">20</span>,<span class="dv">40</span>,<span class="dv">70</span>),(<span class="dv">60</span>,<span class="dv">20</span>,<span class="dv">90</span>,<span class="dv">70</span>),(<span class="dv">100</span>,<span class="dv">10</span>,<span class="dv">130</span>,<span class="dv">60</span>),(<span class="dv">140</span>,<span class="dv">20</span>,<span class="dv">170</span>,<span class="dv">50</span>)]</a>
<a class="sourceLine" id="cb5-5" title="5">  <span class="cf">for</span> i,n <span class="kw">in</span> <span class="bu">enumerate</span>(cuts,<span class="dv">1</span>):</a>
<a class="sourceLine" id="cb5-6" title="6">      temp <span class="op">=</span> p.crop(n) <span class="co"># 调用crop函数进行切割</span></a>
<a class="sourceLine" id="cb5-7" title="7">      temp.save(<span class="st">&quot;cut</span><span class="sc">%s</span><span class="st">.png&quot;</span> <span class="op">%</span> i)</a></code></pre></div></li>
<li>每个正方形边长为10像素，所以数字1切割坐标为左20、上20、右40、下70。以此类推可以知道剩下3个数字的切割位置。</li>
</ul></li>
</ul></li>
<li><p>投影法</p>
<ul>
<li><p>将二值化后的图片在竖直方向进行投影，根据投影后的极值来判断分割边界。</p></li>
<li><div class="sourceCode" id="cb6"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="cb6-1" title="1"><span class="kw">def</span> vertical(img):</a>
<a class="sourceLine" id="cb6-2" title="2">    <span class="co">&quot;&quot;&quot;传入二值化后的图片进行垂直投影&quot;&quot;&quot;</span></a>
<a class="sourceLine" id="cb6-3" title="3">    pixdata <span class="op">=</span> img.load()</a>
<a class="sourceLine" id="cb6-4" title="4">    w,h <span class="op">=</span> img.size</a>
<a class="sourceLine" id="cb6-5" title="5">    ver_list <span class="op">=</span> []</a>
<a class="sourceLine" id="cb6-6" title="6">    <span class="co"># 开始投影</span></a>
<a class="sourceLine" id="cb6-7" title="7">    <span class="cf">for</span> x <span class="kw">in</span> <span class="bu">range</span>(w):</a>
<a class="sourceLine" id="cb6-8" title="8">        black <span class="op">=</span> <span class="dv">0</span></a>
<a class="sourceLine" id="cb6-9" title="9">        <span class="cf">for</span> y <span class="kw">in</span> <span class="bu">range</span>(h):</a>
<a class="sourceLine" id="cb6-10" title="10">            <span class="cf">if</span> pixdata[x,y] <span class="op">==</span> <span class="dv">0</span>:</a>
<a class="sourceLine" id="cb6-11" title="11">                black <span class="op">+=</span> <span class="dv">1</span></a>
<a class="sourceLine" id="cb6-12" title="12">        ver_list.append(black)</a>
<a class="sourceLine" id="cb6-13" title="13">    <span class="co"># 判断边界</span></a>
<a class="sourceLine" id="cb6-14" title="14">    l,r <span class="op">=</span> <span class="dv">0</span>,<span class="dv">0</span></a>
<a class="sourceLine" id="cb6-15" title="15">    flag <span class="op">=</span> <span class="va">False</span></a>
<a class="sourceLine" id="cb6-16" title="16">    cuts <span class="op">=</span> []</a>
<a class="sourceLine" id="cb6-17" title="17">    <span class="cf">for</span> i,count <span class="kw">in</span> <span class="bu">enumerate</span>(ver_list):</a>
<a class="sourceLine" id="cb6-18" title="18">        <span class="co"># 阈值这里为0</span></a>
<a class="sourceLine" id="cb6-19" title="19">        <span class="cf">if</span> flag <span class="kw">is</span> <span class="va">False</span> <span class="kw">and</span> count <span class="op">&gt;</span> <span class="dv">0</span>:</a>
<a class="sourceLine" id="cb6-20" title="20">            l <span class="op">=</span> i</a>
<a class="sourceLine" id="cb6-21" title="21">            flag <span class="op">=</span> <span class="va">True</span></a>
<a class="sourceLine" id="cb6-22" title="22">        <span class="cf">if</span> flag <span class="kw">and</span> count <span class="op">==</span> <span class="dv">0</span>:</a>
<a class="sourceLine" id="cb6-23" title="23">            r <span class="op">=</span> i<span class="dv">-1</span></a>
<a class="sourceLine" id="cb6-24" title="24">            flag <span class="op">=</span> <span class="va">False</span></a>
<a class="sourceLine" id="cb6-25" title="25">            cuts.append((l,r))</a>
<a class="sourceLine" id="cb6-26" title="26">    <span class="cf">return</span> cuts</a>
<a class="sourceLine" id="cb6-27" title="27"></a>
<a class="sourceLine" id="cb6-28" title="28">p <span class="op">=</span> Image.<span class="bu">open</span>(<span class="st">&#39;1.png&#39;</span>)</a>
<a class="sourceLine" id="cb6-29" title="29">b_img <span class="op">=</span> binarizing(p,<span class="dv">200</span>)</a>
<a class="sourceLine" id="cb6-30" title="30">v <span class="op">=</span> vertical(b_img)</a></code></pre></div></li>
</ul></li>
<li><p>CFS连通域分割法(假定每个字符都由一个单独的连通域组成，即无法相连)</p>
<ul>
<li><p>找到一个黑色像素并开始判断，直到所有相连的黑色像素都被遍历标记过后即可判断出这个字符的分割位置。</p></li>
<li><p>算法</p>
<ol type="1">
<li><p>将二值化后的图片进行从左到右、从上到下的遍历，如果遇到黑色像素并且这个像素没有没访问过，就将这个像素入栈并标记为已经访问。</p></li>
<li><p>如果栈不为空，则继续探测周围8个像素，并执行第2步；如果栈空，则代表探测完了一个字符块。</p></li>
<li><p>探测结束，这样就确定了若干字符。</p></li>
</ol></li>
<li><div class="sourceCode" id="cb7"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="cb7-1" title="1"><span class="im">import</span> queue</a>
<a class="sourceLine" id="cb7-2" title="2"></a>
<a class="sourceLine" id="cb7-3" title="3"><span class="kw">def</span> cfs(img):</a>
<a class="sourceLine" id="cb7-4" title="4">    <span class="co">&quot;&quot;&quot;传入二值化后的图片进行连通域分割&quot;&quot;&quot;</span></a>
<a class="sourceLine" id="cb7-5" title="5">    pixdata <span class="op">=</span> img.load()</a>
<a class="sourceLine" id="cb7-6" title="6">    w,h <span class="op">=</span> img.size</a>
<a class="sourceLine" id="cb7-7" title="7">    visited <span class="op">=</span> <span class="bu">set</span>()</a>
<a class="sourceLine" id="cb7-8" title="8">    q <span class="op">=</span> queue.Queue()</a>
<a class="sourceLine" id="cb7-9" title="9">    offset <span class="op">=</span> [(<span class="op">-</span><span class="dv">1</span>,<span class="op">-</span><span class="dv">1</span>),(<span class="dv">0</span>,<span class="op">-</span><span class="dv">1</span>),(<span class="dv">1</span>,<span class="op">-</span><span class="dv">1</span>),(<span class="op">-</span><span class="dv">1</span>,<span class="dv">0</span>),(<span class="dv">1</span>,<span class="dv">0</span>),(<span class="op">-</span><span class="dv">1</span>,<span class="dv">1</span>),(<span class="dv">0</span>,<span class="dv">1</span>),(<span class="dv">1</span>,<span class="dv">1</span>)]</a>
<a class="sourceLine" id="cb7-10" title="10">    cuts <span class="op">=</span> []</a>
<a class="sourceLine" id="cb7-11" title="11">    <span class="cf">for</span> x <span class="kw">in</span> <span class="bu">range</span>(w):</a>
<a class="sourceLine" id="cb7-12" title="12">        <span class="cf">for</span> y <span class="kw">in</span> <span class="bu">range</span>(h):</a>
<a class="sourceLine" id="cb7-13" title="13">            x_axis <span class="op">=</span> []</a>
<a class="sourceLine" id="cb7-14" title="14">            <span class="co">#y_axis = []</span></a>
<a class="sourceLine" id="cb7-15" title="15">            <span class="cf">if</span> pixdata[x,y] <span class="op">==</span> <span class="dv">0</span> <span class="kw">and</span> (x,y) <span class="kw">not</span> <span class="kw">in</span> visited:</a>
<a class="sourceLine" id="cb7-16" title="16">                q.put((x,y))</a>
<a class="sourceLine" id="cb7-17" title="17">                visited.add((x,y))</a>
<a class="sourceLine" id="cb7-18" title="18">            <span class="cf">while</span> <span class="kw">not</span> q.empty():</a>
<a class="sourceLine" id="cb7-19" title="19">                x_p,y_p <span class="op">=</span> q.get()</a>
<a class="sourceLine" id="cb7-20" title="20">                <span class="cf">for</span> x_offset,y_offset <span class="kw">in</span> offset:</a>
<a class="sourceLine" id="cb7-21" title="21">                    x_c,y_c <span class="op">=</span> x_p<span class="op">+</span>x_offset,y_p<span class="op">+</span>y_offset</a>
<a class="sourceLine" id="cb7-22" title="22">                    <span class="cf">if</span> (x_c,y_c) <span class="kw">in</span> visited:</a>
<a class="sourceLine" id="cb7-23" title="23">                        <span class="cf">continue</span></a>
<a class="sourceLine" id="cb7-24" title="24">                    visited.add((x_c,y_c))</a>
<a class="sourceLine" id="cb7-25" title="25">                    <span class="cf">try</span>:</a>
<a class="sourceLine" id="cb7-26" title="26">                        <span class="cf">if</span> pixdata[x_c,y_c] <span class="op">==</span> <span class="dv">0</span>:</a>
<a class="sourceLine" id="cb7-27" title="27">                            q.put((x_c,y_c))</a>
<a class="sourceLine" id="cb7-28" title="28">                            x_axis.append(x_c)</a>
<a class="sourceLine" id="cb7-29" title="29">                            <span class="co">#y_axis.append(y_c)</span></a>
<a class="sourceLine" id="cb7-30" title="30">                    <span class="cf">except</span>:</a>
<a class="sourceLine" id="cb7-31" title="31">                        <span class="cf">pass</span></a>
<a class="sourceLine" id="cb7-32" title="32">            <span class="cf">if</span> x_axis:</a>
<a class="sourceLine" id="cb7-33" title="33">                min_x,max_x <span class="op">=</span> <span class="bu">min</span>(x_axis),<span class="bu">max</span>(x_axis)</a>
<a class="sourceLine" id="cb7-34" title="34">                <span class="cf">if</span> max_x <span class="op">-</span> min_x <span class="op">&gt;</span>  <span class="dv">3</span>:</a>
<a class="sourceLine" id="cb7-35" title="35">                    <span class="co"># 宽度小于3的认为是噪点，根据需要修改</span></a>
<a class="sourceLine" id="cb7-36" title="36">                    cuts.append((min_x,max_x))</a>
<a class="sourceLine" id="cb7-37" title="37">    <span class="cf">return</span> cuts</a></code></pre></div></li>
</ul></li>
</ul>
<h3 id="滑块验证码">滑块验证码</h3>
<h4 id="selenium方案">selenium方案</h4>
<ul>
<li><p>寻找缺块（可根据RBG值，一般为获取一个颜色较深的)</p></li>
<li><p>先把要滑动的距离切成几十份, 并且允许有负数</p></li>
</ul>
<div class="sourceCode" id="cb8"><pre class="sourceCode javascript"><code class="sourceCode javascript"><a class="sourceLine" id="cb8-1" title="1">  <span class="kw">const</span> count <span class="op">=</span> <span class="dv">30</span> <span class="co">// 小编分成30步进行滑动</span></a>
<a class="sourceLine" id="cb8-2" title="2">  <span class="kw">const</span> steps <span class="op">=</span> <span class="at">getSteps</span>(distance<span class="op">,</span> count)</a>
<a class="sourceLine" id="cb8-3" title="3">  <span class="kw">const</span> totalDuration <span class="op">=</span> <span class="dv">8000</span> <span class="co">// 一共耗时8秒, 慢才能充实轨迹~</span></a>
<a class="sourceLine" id="cb8-4" title="4"></a>
<a class="sourceLine" id="cb8-5" title="5"></a>
<a class="sourceLine" id="cb8-6" title="6"><span class="va">_</span>.<span class="at">reduce</span>(steps<span class="op">,</span> (actions<span class="op">,</span> step) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb8-7" title="7">  <span class="cf">return</span> <span class="va">actions</span>.<span class="at">move</span>(<span class="op">{</span></a>
<a class="sourceLine" id="cb8-8" title="8">    <span class="dt">x</span><span class="op">:</span> x <span class="op">+</span> <span class="dv">10</span> <span class="op">+</span> step<span class="op">,</span></a>
<a class="sourceLine" id="cb8-9" title="9">    <span class="dt">y</span><span class="op">:</span> y <span class="op">+</span> <span class="dv">10</span> <span class="op">+</span> <span class="va">_</span>.<span class="at">random</span>(<span class="op">-</span><span class="dv">5</span><span class="op">,</span> <span class="dv">40</span>)<span class="op">,</span> <span class="co">// 加上y轴随机数</span></a>
<a class="sourceLine" id="cb8-10" title="10">    <span class="dt">duration</span><span class="op">:</span> <span class="at">parseInt</span>(<span class="va">_</span>.<span class="at">random</span>(totalDuration / count / <span class="dv">2</span><span class="op">,</span> totalDuration / count <span class="op">*</span> <span class="dv">2</span>)) <span class="co">// 加上时长随机数</span></a>
<a class="sourceLine" id="cb8-11" title="11">  <span class="op">}</span>)</a>
<a class="sourceLine" id="cb8-12" title="12"><span class="op">},</span> actions)</a>
<a class="sourceLine" id="cb8-13" title="13"></a>
<a class="sourceLine" id="cb8-14" title="14"><span class="co">// 随机拆成n份</span></a>
<a class="sourceLine" id="cb8-15" title="15"><span class="kw">function</span> <span class="at">getRandomDistribution</span>(total<span class="op">,</span> count) <span class="op">{</span></a>
<a class="sourceLine" id="cb8-16" title="16">  <span class="kw">let</span> item <span class="op">=</span> total / count</a>
<a class="sourceLine" id="cb8-17" title="17">  item <span class="op">=</span> item <span class="op">+</span> <span class="va">_</span>.<span class="at">random</span>(<span class="op">-</span>item <span class="op">*</span> <span class="dv">2</span><span class="op">,</span> item <span class="op">*</span> <span class="dv">3</span>)</a>
<a class="sourceLine" id="cb8-18" title="18">  item <span class="op">=</span> <span class="at">parseInt</span>(item)</a>
<a class="sourceLine" id="cb8-19" title="19">  <span class="cf">if</span> (count <span class="op">===</span> <span class="dv">1</span>) <span class="op">{</span></a>
<a class="sourceLine" id="cb8-20" title="20">    <span class="cf">return</span> [total]</a>
<a class="sourceLine" id="cb8-21" title="21">  <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb8-22" title="22">    <span class="cf">return</span> [item].<span class="at">concat</span>(<span class="at">getRandomDistribution</span>(total <span class="op">-</span> item<span class="op">,</span> count <span class="op">-</span> <span class="dv">1</span>))</a>
<a class="sourceLine" id="cb8-23" title="23">  <span class="op">}</span></a>
<a class="sourceLine" id="cb8-24" title="24"><span class="op">}</span></a>
<a class="sourceLine" id="cb8-25" title="25"></a>
<a class="sourceLine" id="cb8-26" title="26"><span class="co">// 获取每次滑动的X坐标</span></a>
<a class="sourceLine" id="cb8-27" title="27"><span class="kw">function</span> <span class="at">getSteps</span>(total<span class="op">,</span> count) <span class="op">{</span></a>
<a class="sourceLine" id="cb8-28" title="28">  <span class="kw">let</span> distribution <span class="op">=</span> <span class="at">getRandomDistribution</span>(total<span class="op">,</span> count)</a>
<a class="sourceLine" id="cb8-29" title="29">  <span class="cf">return</span> <span class="va">_</span>.<span class="at">map</span>(distribution<span class="op">,</span> (item<span class="op">,</span> i) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb8-30" title="30">    <span class="cf">return</span> <span class="va">_</span>.<span class="at">sum</span>(<span class="va">distribution</span>.<span class="at">slice</span>(<span class="dv">0</span><span class="op">,</span> i <span class="op">+</span> <span class="dv">1</span>))</a>
<a class="sourceLine" id="cb8-31" title="31">  <span class="op">}</span>)</a>
<a class="sourceLine" id="cb8-32" title="32"><span class="op">}</span><span class="vs">```</span></a></code></pre></div>
<h3 id="滴水算法分割图片">滴水算法分割图片</h3>
<div class="sourceCode" id="cb9"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="cb9-1" title="1"><span class="im">from</span> itertools <span class="im">import</span> groupby</a>
<a class="sourceLine" id="cb9-2" title="2"></a>
<a class="sourceLine" id="cb9-3" title="3"><span class="kw">def</span> binarizing(img,threshold):</a>
<a class="sourceLine" id="cb9-4" title="4">    <span class="co">&quot;&quot;&quot;传入image对象进行灰度、二值处理&quot;&quot;&quot;</span></a>
<a class="sourceLine" id="cb9-5" title="5">    img <span class="op">=</span> img.convert(<span class="st">&quot;L&quot;</span>) <span class="co"># 转灰度</span></a>
<a class="sourceLine" id="cb9-6" title="6">    pixdata <span class="op">=</span> img.load()</a>
<a class="sourceLine" id="cb9-7" title="7">    w, h <span class="op">=</span> img.size</a>
<a class="sourceLine" id="cb9-8" title="8">    <span class="co"># 遍历所有像素，大于阈值的为黑色</span></a>
<a class="sourceLine" id="cb9-9" title="9">    <span class="cf">for</span> y <span class="kw">in</span> <span class="bu">range</span>(h):</a>
<a class="sourceLine" id="cb9-10" title="10">        <span class="cf">for</span> x <span class="kw">in</span> <span class="bu">range</span>(w):</a>
<a class="sourceLine" id="cb9-11" title="11">            <span class="cf">if</span> pixdata[x, y] <span class="op">&lt;</span> threshold:</a>
<a class="sourceLine" id="cb9-12" title="12">                pixdata[x, y] <span class="op">=</span> <span class="dv">0</span></a>
<a class="sourceLine" id="cb9-13" title="13">            <span class="cf">else</span>:</a>
<a class="sourceLine" id="cb9-14" title="14">                pixdata[x, y] <span class="op">=</span> <span class="dv">255</span></a>
<a class="sourceLine" id="cb9-15" title="15">    <span class="cf">return</span> img</a>
<a class="sourceLine" id="cb9-16" title="16"></a>
<a class="sourceLine" id="cb9-17" title="17"><span class="kw">def</span> vertical(img):</a>
<a class="sourceLine" id="cb9-18" title="18">    <span class="co">&quot;&quot;&quot;传入二值化后的图片进行垂直投影&quot;&quot;&quot;</span></a>
<a class="sourceLine" id="cb9-19" title="19">    pixdata <span class="op">=</span> img.load()</a>
<a class="sourceLine" id="cb9-20" title="20">    w,h <span class="op">=</span> img.size</a>
<a class="sourceLine" id="cb9-21" title="21">    result <span class="op">=</span> []</a>
<a class="sourceLine" id="cb9-22" title="22">    <span class="cf">for</span> x <span class="kw">in</span> <span class="bu">range</span>(w):</a>
<a class="sourceLine" id="cb9-23" title="23">        black <span class="op">=</span> <span class="dv">0</span></a>
<a class="sourceLine" id="cb9-24" title="24">        <span class="cf">for</span> y <span class="kw">in</span> <span class="bu">range</span>(h):</a>
<a class="sourceLine" id="cb9-25" title="25">            <span class="cf">if</span> pixdata[x,y] <span class="op">==</span> <span class="dv">0</span>:</a>
<a class="sourceLine" id="cb9-26" title="26">                black <span class="op">+=</span> <span class="dv">1</span></a>
<a class="sourceLine" id="cb9-27" title="27">        result.append(black)</a>
<a class="sourceLine" id="cb9-28" title="28">    <span class="cf">return</span> result</a>
<a class="sourceLine" id="cb9-29" title="29"></a>
<a class="sourceLine" id="cb9-30" title="30"><span class="kw">def</span> get_start_x(hist_width):</a>
<a class="sourceLine" id="cb9-31" title="31">    <span class="co">&quot;&quot;&quot;根据图片垂直投影的结果来确定起点</span></a>
<a class="sourceLine" id="cb9-32" title="32"><span class="co">       hist_width中间值 前后取4个值 再这范围内取最小值</span></a>
<a class="sourceLine" id="cb9-33" title="33"><span class="co">    &quot;&quot;&quot;</span></a>
<a class="sourceLine" id="cb9-34" title="34">    mid <span class="op">=</span> <span class="bu">len</span>(hist_width) <span class="op">//</span> <span class="dv">2</span> <span class="co"># 注意py3 除法和py2不同</span></a>
<a class="sourceLine" id="cb9-35" title="35">    temp <span class="op">=</span> hist_width[mid<span class="dv">-4</span>:mid<span class="op">+</span><span class="dv">5</span>]</a>
<a class="sourceLine" id="cb9-36" title="36">    <span class="cf">return</span> mid <span class="op">-</span> <span class="dv">4</span> <span class="op">+</span> temp.index(<span class="bu">min</span>(temp))</a>
<a class="sourceLine" id="cb9-37" title="37"></a>
<a class="sourceLine" id="cb9-38" title="38"><span class="kw">def</span> get_nearby_pix_value(img_pix,x,y,j):</a>
<a class="sourceLine" id="cb9-39" title="39">    <span class="co">&quot;&quot;&quot;获取临近5个点像素数据&quot;&quot;&quot;</span></a>
<a class="sourceLine" id="cb9-40" title="40">    <span class="cf">if</span> j <span class="op">==</span> <span class="dv">1</span>:</a>
<a class="sourceLine" id="cb9-41" title="41">        <span class="cf">return</span> <span class="dv">0</span> <span class="cf">if</span> img_pix[x<span class="dv">-1</span>,y<span class="op">+</span><span class="dv">1</span>] <span class="op">==</span> <span class="dv">0</span> <span class="cf">else</span> <span class="dv">1</span></a>
<a class="sourceLine" id="cb9-42" title="42">    <span class="cf">elif</span> j <span class="op">==</span><span class="dv">2</span>:</a>
<a class="sourceLine" id="cb9-43" title="43">        <span class="cf">return</span> <span class="dv">0</span> <span class="cf">if</span> img_pix[x,y<span class="op">+</span><span class="dv">1</span>] <span class="op">==</span> <span class="dv">0</span> <span class="cf">else</span> <span class="dv">1</span></a>
<a class="sourceLine" id="cb9-44" title="44">    <span class="cf">elif</span> j <span class="op">==</span><span class="dv">3</span>:</a>
<a class="sourceLine" id="cb9-45" title="45">        <span class="cf">return</span> <span class="dv">0</span> <span class="cf">if</span> img_pix[x<span class="op">+</span><span class="dv">1</span>,y<span class="op">+</span><span class="dv">1</span>] <span class="op">==</span> <span class="dv">0</span> <span class="cf">else</span> <span class="dv">1</span></a>
<a class="sourceLine" id="cb9-46" title="46">    <span class="cf">elif</span> j <span class="op">==</span><span class="dv">4</span>:</a>
<a class="sourceLine" id="cb9-47" title="47">        <span class="cf">return</span> <span class="dv">0</span> <span class="cf">if</span> img_pix[x<span class="op">+</span><span class="dv">1</span>,y] <span class="op">==</span> <span class="dv">0</span> <span class="cf">else</span> <span class="dv">1</span></a>
<a class="sourceLine" id="cb9-48" title="48">    <span class="cf">elif</span> j <span class="op">==</span><span class="dv">5</span>:</a>
<a class="sourceLine" id="cb9-49" title="49">        <span class="cf">return</span> <span class="dv">0</span> <span class="cf">if</span> img_pix[x<span class="dv">-1</span>,y] <span class="op">==</span> <span class="dv">0</span> <span class="cf">else</span> <span class="dv">1</span></a>
<a class="sourceLine" id="cb9-50" title="50">    <span class="cf">else</span>:</a>
<a class="sourceLine" id="cb9-51" title="51">        <span class="cf">raise</span> <span class="pp">Exception</span>(<span class="st">&quot;get_nearby_pix_value error&quot;</span>)</a>
<a class="sourceLine" id="cb9-52" title="52"></a>
<a class="sourceLine" id="cb9-53" title="53"></a>
<a class="sourceLine" id="cb9-54" title="54"><span class="kw">def</span> get_end_route(img,start_x,height):</a>
<a class="sourceLine" id="cb9-55" title="55">    <span class="co">&quot;&quot;&quot;获取滴水路径&quot;&quot;&quot;</span></a>
<a class="sourceLine" id="cb9-56" title="56">    left_limit <span class="op">=</span> <span class="dv">0</span></a>
<a class="sourceLine" id="cb9-57" title="57">    right_limit <span class="op">=</span> img.size[<span class="dv">0</span>] <span class="op">-</span> <span class="dv">1</span></a>
<a class="sourceLine" id="cb9-58" title="58">    end_route <span class="op">=</span> []</a>
<a class="sourceLine" id="cb9-59" title="59">    cur_p <span class="op">=</span> (start_x,<span class="dv">0</span>)</a>
<a class="sourceLine" id="cb9-60" title="60">    last_p <span class="op">=</span> cur_p</a>
<a class="sourceLine" id="cb9-61" title="61">    end_route.append(cur_p)</a>
<a class="sourceLine" id="cb9-62" title="62"></a>
<a class="sourceLine" id="cb9-63" title="63">    <span class="cf">while</span> cur_p[<span class="dv">1</span>] <span class="op">&lt;</span> (height<span class="dv">-1</span>):</a>
<a class="sourceLine" id="cb9-64" title="64">        sum_n <span class="op">=</span> <span class="dv">0</span></a>
<a class="sourceLine" id="cb9-65" title="65">        max_w <span class="op">=</span> <span class="dv">0</span></a>
<a class="sourceLine" id="cb9-66" title="66">        next_x <span class="op">=</span> cur_p[<span class="dv">0</span>]</a>
<a class="sourceLine" id="cb9-67" title="67">        next_y <span class="op">=</span> cur_p[<span class="dv">1</span>]</a>
<a class="sourceLine" id="cb9-68" title="68">        pix_img <span class="op">=</span> img.load()</a>
<a class="sourceLine" id="cb9-69" title="69">        <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">1</span>,<span class="dv">6</span>):</a>
<a class="sourceLine" id="cb9-70" title="70">            cur_w <span class="op">=</span> get_nearby_pix_value(pix_img,cur_p[<span class="dv">0</span>],cur_p[<span class="dv">1</span>],i) <span class="op">*</span> (<span class="dv">6</span><span class="op">-</span>i)</a>
<a class="sourceLine" id="cb9-71" title="71">            sum_n <span class="op">+=</span> cur_w</a>
<a class="sourceLine" id="cb9-72" title="72">            <span class="cf">if</span> max_w <span class="op">&lt;</span> cur_w:</a>
<a class="sourceLine" id="cb9-73" title="73">                max_w <span class="op">=</span> cur_w</a>
<a class="sourceLine" id="cb9-74" title="74">        <span class="cf">if</span> sum_n <span class="op">==</span> <span class="dv">0</span>:</a>
<a class="sourceLine" id="cb9-75" title="75">            <span class="co"># 如果全黑则看惯性</span></a>
<a class="sourceLine" id="cb9-76" title="76">            max_w <span class="op">=</span> <span class="dv">4</span></a>
<a class="sourceLine" id="cb9-77" title="77">        <span class="cf">if</span> sum_n <span class="op">==</span> <span class="dv">15</span>:</a>
<a class="sourceLine" id="cb9-78" title="78">            max_w <span class="op">=</span> <span class="dv">6</span></a>
<a class="sourceLine" id="cb9-79" title="79"></a>
<a class="sourceLine" id="cb9-80" title="80">        <span class="cf">if</span> max_w <span class="op">==</span> <span class="dv">1</span>:</a>
<a class="sourceLine" id="cb9-81" title="81">            next_x <span class="op">=</span> cur_p[<span class="dv">0</span>] <span class="op">-</span> <span class="dv">1</span></a>
<a class="sourceLine" id="cb9-82" title="82">            next_y <span class="op">=</span> cur_p[<span class="dv">1</span>]</a>
<a class="sourceLine" id="cb9-83" title="83">        <span class="cf">elif</span> max_w <span class="op">==</span> <span class="dv">2</span>:</a>
<a class="sourceLine" id="cb9-84" title="84">            next_x <span class="op">=</span> cur_p[<span class="dv">0</span>] <span class="op">+</span> <span class="dv">1</span></a>
<a class="sourceLine" id="cb9-85" title="85">            next_y <span class="op">=</span> cur_p[<span class="dv">1</span>]</a>
<a class="sourceLine" id="cb9-86" title="86">        <span class="cf">elif</span> max_w <span class="op">==</span> <span class="dv">3</span>:</a>
<a class="sourceLine" id="cb9-87" title="87">            next_x <span class="op">=</span> cur_p[<span class="dv">0</span>] <span class="op">+</span> <span class="dv">1</span></a>
<a class="sourceLine" id="cb9-88" title="88">            next_y <span class="op">=</span> cur_p[<span class="dv">1</span>] <span class="op">+</span> <span class="dv">1</span></a>
<a class="sourceLine" id="cb9-89" title="89">        <span class="cf">elif</span> max_w <span class="op">==</span> <span class="dv">5</span>:</a>
<a class="sourceLine" id="cb9-90" title="90">            next_x <span class="op">=</span> cur_p[<span class="dv">0</span>] <span class="op">-</span> <span class="dv">1</span></a>
<a class="sourceLine" id="cb9-91" title="91">            next_y <span class="op">=</span> cur_p[<span class="dv">1</span>] <span class="op">+</span> <span class="dv">1</span></a>
<a class="sourceLine" id="cb9-92" title="92">        <span class="cf">elif</span> max_w <span class="op">==</span> <span class="dv">6</span>:</a>
<a class="sourceLine" id="cb9-93" title="93">            next_x <span class="op">=</span> cur_p[<span class="dv">0</span>]</a>
<a class="sourceLine" id="cb9-94" title="94">            next_y <span class="op">=</span> cur_p[<span class="dv">1</span>] <span class="op">+</span> <span class="dv">1</span></a>
<a class="sourceLine" id="cb9-95" title="95">        <span class="cf">elif</span> max_w <span class="op">==</span> <span class="dv">4</span>:</a>
<a class="sourceLine" id="cb9-96" title="96">            <span class="cf">if</span> next_x <span class="op">&gt;</span> last_p[<span class="dv">0</span>]:</a>
<a class="sourceLine" id="cb9-97" title="97">                <span class="co"># 向右</span></a>
<a class="sourceLine" id="cb9-98" title="98">                next_x <span class="op">=</span> cur_p[<span class="dv">0</span>] <span class="op">+</span> <span class="dv">1</span></a>
<a class="sourceLine" id="cb9-99" title="99">                next_y <span class="op">=</span> cur_p[<span class="dv">1</span>] <span class="op">+</span> <span class="dv">1</span></a>
<a class="sourceLine" id="cb9-100" title="100">            <span class="cf">if</span> next_x <span class="op">&lt;</span> last_p[<span class="dv">0</span>]:</a>
<a class="sourceLine" id="cb9-101" title="101">                next_x <span class="op">=</span> cur_p[<span class="dv">0</span>]</a>
<a class="sourceLine" id="cb9-102" title="102">                next_y <span class="op">=</span> cur_p[<span class="dv">1</span>] <span class="op">+</span> <span class="dv">1</span></a>
<a class="sourceLine" id="cb9-103" title="103">            <span class="cf">if</span> sum_n <span class="op">==</span> <span class="dv">0</span>:</a>
<a class="sourceLine" id="cb9-104" title="104">                next_x <span class="op">=</span> cur_p[<span class="dv">0</span>]</a>
<a class="sourceLine" id="cb9-105" title="105">                next_y <span class="op">=</span> cur_p[<span class="dv">1</span>] <span class="op">+</span> <span class="dv">1</span></a>
<a class="sourceLine" id="cb9-106" title="106">        <span class="cf">else</span>:</a>
<a class="sourceLine" id="cb9-107" title="107">            <span class="cf">raise</span> <span class="pp">Exception</span>(<span class="st">&quot;get end route error&quot;</span>)</a>
<a class="sourceLine" id="cb9-108" title="108"></a>
<a class="sourceLine" id="cb9-109" title="109">        <span class="cf">if</span> last_p[<span class="dv">0</span>] <span class="op">==</span> next_x <span class="kw">and</span> last_p[<span class="dv">1</span>] <span class="op">==</span> next_y:</a>
<a class="sourceLine" id="cb9-110" title="110">            <span class="cf">if</span> next_x <span class="op">&lt;</span> cur_p[<span class="dv">0</span>]:</a>
<a class="sourceLine" id="cb9-111" title="111">                max_w <span class="op">=</span> <span class="dv">5</span></a>
<a class="sourceLine" id="cb9-112" title="112">                next_x <span class="op">=</span> cur_p[<span class="dv">0</span>] <span class="op">+</span> <span class="dv">1</span></a>
<a class="sourceLine" id="cb9-113" title="113">                next_y <span class="op">=</span> cur_p[<span class="dv">1</span>] <span class="op">+</span> <span class="dv">1</span></a>
<a class="sourceLine" id="cb9-114" title="114">            <span class="cf">else</span>:</a>
<a class="sourceLine" id="cb9-115" title="115">                max_w <span class="op">=</span> <span class="dv">3</span></a>
<a class="sourceLine" id="cb9-116" title="116">                next_x <span class="op">=</span> cur_p[<span class="dv">0</span>] <span class="op">-</span> <span class="dv">1</span></a>
<a class="sourceLine" id="cb9-117" title="117">                next_y <span class="op">=</span> cur_p[<span class="dv">1</span>] <span class="op">+</span> <span class="dv">1</span></a>
<a class="sourceLine" id="cb9-118" title="118">        last_p <span class="op">=</span> cur_p</a>
<a class="sourceLine" id="cb9-119" title="119"></a>
<a class="sourceLine" id="cb9-120" title="120">        <span class="cf">if</span> next_x <span class="op">&gt;</span> right_limit:</a>
<a class="sourceLine" id="cb9-121" title="121">            next_x <span class="op">=</span> right_limit</a>
<a class="sourceLine" id="cb9-122" title="122">            next_y <span class="op">=</span> cur_p[<span class="dv">1</span>] <span class="op">+</span> <span class="dv">1</span></a>
<a class="sourceLine" id="cb9-123" title="123">        <span class="cf">if</span> next_x <span class="op">&lt;</span> left_limit:</a>
<a class="sourceLine" id="cb9-124" title="124">            next_x <span class="op">=</span> left_limit</a>
<a class="sourceLine" id="cb9-125" title="125">            next_y <span class="op">=</span> cur_p[<span class="dv">1</span>] <span class="op">+</span> <span class="dv">1</span></a>
<a class="sourceLine" id="cb9-126" title="126">        cur_p <span class="op">=</span> (next_x,next_y)</a>
<a class="sourceLine" id="cb9-127" title="127">        end_route.append(cur_p)</a>
<a class="sourceLine" id="cb9-128" title="128">    <span class="cf">return</span> end_route</a>
<a class="sourceLine" id="cb9-129" title="129"></a>
<a class="sourceLine" id="cb9-130" title="130"><span class="kw">def</span> get_split_seq(projection_x):</a>
<a class="sourceLine" id="cb9-131" title="131">    split_seq <span class="op">=</span> []</a>
<a class="sourceLine" id="cb9-132" title="132">    start_x <span class="op">=</span> <span class="dv">0</span></a>
<a class="sourceLine" id="cb9-133" title="133">    length <span class="op">=</span> <span class="dv">0</span></a>
<a class="sourceLine" id="cb9-134" title="134">    <span class="cf">for</span> pos_x, val <span class="kw">in</span> <span class="bu">enumerate</span>(projection_x):</a>
<a class="sourceLine" id="cb9-135" title="135">        <span class="cf">if</span> val <span class="op">==</span> <span class="dv">0</span> <span class="kw">and</span> length <span class="op">==</span> <span class="dv">0</span>:</a>
<a class="sourceLine" id="cb9-136" title="136">            <span class="cf">continue</span></a>
<a class="sourceLine" id="cb9-137" title="137">        <span class="cf">elif</span> val <span class="op">==</span> <span class="dv">0</span> <span class="kw">and</span> length <span class="op">!=</span> <span class="dv">0</span>:</a>
<a class="sourceLine" id="cb9-138" title="138">            split_seq.append([start_x, length])</a>
<a class="sourceLine" id="cb9-139" title="139">            length <span class="op">=</span> <span class="dv">0</span></a>
<a class="sourceLine" id="cb9-140" title="140">        <span class="cf">elif</span> val <span class="op">==</span> <span class="dv">1</span>:</a>
<a class="sourceLine" id="cb9-141" title="141">            <span class="cf">if</span> length <span class="op">==</span> <span class="dv">0</span>:</a>
<a class="sourceLine" id="cb9-142" title="142">                start_x <span class="op">=</span> pos_x</a>
<a class="sourceLine" id="cb9-143" title="143">            length <span class="op">+=</span> <span class="dv">1</span></a>
<a class="sourceLine" id="cb9-144" title="144">        <span class="cf">else</span>:</a>
<a class="sourceLine" id="cb9-145" title="145">            <span class="cf">raise</span> <span class="pp">Exception</span>(<span class="st">&#39;generating split sequence occurs error&#39;</span>)</a>
<a class="sourceLine" id="cb9-146" title="146">    <span class="co"># 循环结束时如果length不为0，说明还有一部分需要append</span></a>
<a class="sourceLine" id="cb9-147" title="147">    <span class="cf">if</span> length <span class="op">!=</span> <span class="dv">0</span>:</a>
<a class="sourceLine" id="cb9-148" title="148">        split_seq.append([start_x, length])</a>
<a class="sourceLine" id="cb9-149" title="149">    <span class="cf">return</span> split_seq</a>
<a class="sourceLine" id="cb9-150" title="150"></a>
<a class="sourceLine" id="cb9-151" title="151"></a>
<a class="sourceLine" id="cb9-152" title="152"><span class="kw">def</span> do_split(source_image, starts, filter_ends):</a>
<a class="sourceLine" id="cb9-153" title="153">    <span class="co">&quot;&quot;&quot;</span></a>
<a class="sourceLine" id="cb9-154" title="154"><span class="co">    具体实行切割</span></a>
<a class="sourceLine" id="cb9-155" title="155"><span class="co">    : param starts: 每一行的起始点 tuple of list</span></a>
<a class="sourceLine" id="cb9-156" title="156"><span class="co">    : param ends: 每一行的终止点</span></a>
<a class="sourceLine" id="cb9-157" title="157"><span class="co">    &quot;&quot;&quot;</span></a>
<a class="sourceLine" id="cb9-158" title="158">    left <span class="op">=</span> starts[<span class="dv">0</span>][<span class="dv">0</span>]</a>
<a class="sourceLine" id="cb9-159" title="159">    top <span class="op">=</span> starts[<span class="dv">0</span>][<span class="dv">1</span>]</a>
<a class="sourceLine" id="cb9-160" title="160">    right <span class="op">=</span> filter_ends[<span class="dv">0</span>][<span class="dv">0</span>]</a>
<a class="sourceLine" id="cb9-161" title="161">    bottom <span class="op">=</span> filter_ends[<span class="dv">0</span>][<span class="dv">1</span>]</a>
<a class="sourceLine" id="cb9-162" title="162">    pixdata <span class="op">=</span> source_image.load()</a>
<a class="sourceLine" id="cb9-163" title="163">    <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="bu">len</span>(starts)):</a>
<a class="sourceLine" id="cb9-164" title="164">        left <span class="op">=</span> <span class="bu">min</span>(starts[i][<span class="dv">0</span>], left)</a>
<a class="sourceLine" id="cb9-165" title="165">        top <span class="op">=</span> <span class="bu">min</span>(starts[i][<span class="dv">1</span>], top)</a>
<a class="sourceLine" id="cb9-166" title="166">        right <span class="op">=</span> <span class="bu">max</span>(filter_ends[i][<span class="dv">0</span>], right)</a>
<a class="sourceLine" id="cb9-167" title="167">        bottom <span class="op">=</span> <span class="bu">max</span>(filter_ends[i][<span class="dv">1</span>], bottom)</a>
<a class="sourceLine" id="cb9-168" title="168">    width <span class="op">=</span> right <span class="op">-</span> left <span class="op">+</span> <span class="dv">1</span></a>
<a class="sourceLine" id="cb9-169" title="169">    height <span class="op">=</span> bottom <span class="op">-</span> top <span class="op">+</span> <span class="dv">1</span></a>
<a class="sourceLine" id="cb9-170" title="170">    image <span class="op">=</span> Image.new(<span class="st">&#39;RGB&#39;</span>, (width, height), (<span class="dv">255</span>,<span class="dv">255</span>,<span class="dv">255</span>))</a>
<a class="sourceLine" id="cb9-171" title="171">    <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(height):</a>
<a class="sourceLine" id="cb9-172" title="172">        start <span class="op">=</span> starts[i]</a>
<a class="sourceLine" id="cb9-173" title="173">        end <span class="op">=</span> filter_ends[i]</a>
<a class="sourceLine" id="cb9-174" title="174">        <span class="cf">for</span> x <span class="kw">in</span> <span class="bu">range</span>(start[<span class="dv">0</span>], end[<span class="dv">0</span>]<span class="op">+</span><span class="dv">1</span>):</a>
<a class="sourceLine" id="cb9-175" title="175">            <span class="cf">if</span> pixdata[x,start[<span class="dv">1</span>]] <span class="op">==</span> <span class="dv">0</span>:</a>
<a class="sourceLine" id="cb9-176" title="176">                image.putpixel((x <span class="op">-</span> left, start[<span class="dv">1</span>] <span class="op">-</span> top), (<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">0</span>))</a>
<a class="sourceLine" id="cb9-177" title="177">    <span class="cf">return</span> image</a>
<a class="sourceLine" id="cb9-178" title="178"></a>
<a class="sourceLine" id="cb9-179" title="179"><span class="kw">def</span> drop_fall(img):</a>
<a class="sourceLine" id="cb9-180" title="180">    <span class="co">&quot;&quot;&quot;滴水分割&quot;&quot;&quot;</span></a>
<a class="sourceLine" id="cb9-181" title="181">    width,height <span class="op">=</span> img.size</a>
<a class="sourceLine" id="cb9-182" title="182">    <span class="co"># 1 二值化</span></a>
<a class="sourceLine" id="cb9-183" title="183">    b_img <span class="op">=</span> binarizing(img,<span class="dv">200</span>)</a>
<a class="sourceLine" id="cb9-184" title="184">    <span class="co"># 2 垂直投影</span></a>
<a class="sourceLine" id="cb9-185" title="185">    hist_width <span class="op">=</span> vertical(b_img)</a>
<a class="sourceLine" id="cb9-186" title="186">    <span class="co"># 3 获取起点</span></a>
<a class="sourceLine" id="cb9-187" title="187">    start_x <span class="op">=</span> get_start_x(hist_width)</a>
<a class="sourceLine" id="cb9-188" title="188"></a>
<a class="sourceLine" id="cb9-189" title="189">    <span class="co"># 4 开始滴水算法</span></a>
<a class="sourceLine" id="cb9-190" title="190">    start_route <span class="op">=</span> []</a>
<a class="sourceLine" id="cb9-191" title="191">    <span class="cf">for</span> y <span class="kw">in</span> <span class="bu">range</span>(height):</a>
<a class="sourceLine" id="cb9-192" title="192">        start_route.append((<span class="dv">0</span>,y))</a>
<a class="sourceLine" id="cb9-193" title="193"></a>
<a class="sourceLine" id="cb9-194" title="194">    end_route <span class="op">=</span> get_end_route(img,start_x,height)</a>
<a class="sourceLine" id="cb9-195" title="195">    filter_end_route <span class="op">=</span> [<span class="bu">max</span>(<span class="bu">list</span>(k)) <span class="cf">for</span> _,k <span class="kw">in</span> groupby(end_route,<span class="kw">lambda</span> x:x[<span class="dv">1</span>])] <span class="co"># 注意这里groupby</span></a>
<a class="sourceLine" id="cb9-196" title="196">    img1 <span class="op">=</span> do_split(img,start_route,filter_end_route)</a>
<a class="sourceLine" id="cb9-197" title="197">    img1.save(<span class="st">&#39;cuts-d-1.png&#39;</span>)</a>
<a class="sourceLine" id="cb9-198" title="198"></a>
<a class="sourceLine" id="cb9-199" title="199">    start_route <span class="op">=</span> <span class="bu">list</span>(<span class="bu">map</span>(<span class="kw">lambda</span> x : (x[<span class="dv">0</span>]<span class="op">+</span><span class="dv">1</span>,x[<span class="dv">1</span>]),filter_end_route)) <span class="co"># python3中map不返回list需要自己转换</span></a>
<a class="sourceLine" id="cb9-200" title="200">    end_route <span class="op">=</span> []</a>
<a class="sourceLine" id="cb9-201" title="201">    <span class="cf">for</span> y <span class="kw">in</span> <span class="bu">range</span>(height):</a>
<a class="sourceLine" id="cb9-202" title="202">        end_route.append((width<span class="dv">-1</span>,y))</a>
<a class="sourceLine" id="cb9-203" title="203">    img2 <span class="op">=</span> do_split(img,start_route,end_route)</a>
<a class="sourceLine" id="cb9-204" title="204">    img2.save(<span class="st">&#39;cuts-d-2.png&#39;</span>)</a>
<a class="sourceLine" id="cb9-205" title="205"></a>
<a class="sourceLine" id="cb9-206" title="206"><span class="cf">if</span> <span class="va">__name__</span> <span class="op">==</span> <span class="st">&#39;__main__&#39;</span>:</a>
<a class="sourceLine" id="cb9-207" title="207">    p <span class="op">=</span> Image.<span class="bu">open</span>(<span class="st">&quot;cuts-2.png&quot;</span>)</a>
<a class="sourceLine" id="cb9-208" title="208">    drop_fall(p)</a></code></pre></div>
</body>
</html>
